<!DOCTYPE html>
<html>
	<head>
	  <meta charset="utf-8"/>
	  <meta name="viewport" content="width=device-width"/>
		<link rel="stylesheet" type="text/css" href="css/index.css">
		<title>Tetris</title>
		<script src="webxdc.js"></script>
	</head>
	<body>
		<div class="app" id="touch">
			<center>
				<canvas id="background" width="1000" height="2000"></canvas>
				<canvas id="playfield" width="1000" height="2000"></canvas>
				<div id="scoreboard"></div>
				<br>
				<a class="UI">Gesture sensitivity: </a><select id="sencontrol">
				  <option value="1">1</option>
				  <option value="2">2</option>
				  <option value="3">3</option>
				  <option value="4" selected>4</option>
				  <option value="5">5</option>
				  <option value="6">6</option>
				  <option value="7">7</option>
				  <option value="8">8</option>
				  <option value="9">9</option>
				  <option value="10">10</option>
				</select>
				<div class="UI" id="tip">
				  <br>Touch anywhere to start
          <!--
					<button onclick="move(-1, playfield, falling, true)">&larr;</button>
					<button onclick="rotate(playfield, falling, true)">&#8635;</button>
					<button onclick="move(1, playfield, falling, true)">&rarr;</button>
					<p></p>
					<br>
					<button onclick="fall(playfield, falling, true)">&darr;</button>
					-->
				</div>
			</center>
		</div>
		<div class="hidden">
			<img id="square" src="img/square.png" width="100" height="100">
		</div>
		<script type="text/javascript" src="js/Noise.js"></script>
		<script type="text/javascript" src="js/main.js"></script>
		<script type="text/javascript" src="webxdc-scores.js"></script>
		<script type="text/javascript">
		document.addEventListener("visibilitychange", function() {
      saveGame();
    });
    window.addEventListener("load", function() {
       eruda.init();
		   window.highscores.init("Tetris", "scoreboard").then(() => {
       restoreGame();
       scoreboard.classList.add("opened");
		   });
    });
    window.addEventListener("resize", function() {
      setup();
    });
    window.addEventListener("pointerup", function() {
      start();
    });
    let portrait = window.matchMedia("(orientation: portrait)");
    portrait.addEventListener("change", function() { 
      setup();
    });
document.addEventListener('touchstart', handleTouchStart, false);        
document.addEventListener('touchmove', handleTouchMove, false);

var xDown = null;                                                        
var yDown = null;

var xtrigger = 0;
var ytrigger = 0;
var dtrigger = 0;

function getTouches(evt) {
  return evt.touches ||             // browser API
         evt.originalEvent.touches; // jQuery
}                                                     
                                                                         
function handleTouchStart(evt) {
    const firstTouch = getTouches(evt)[0];                                      
    xDown = firstTouch.clientX;                                      
    yDown = firstTouch.clientY;
    xtrigger = 0;
    ytrigger = 0;
    dtrigger = 0;
};                                                
                                                                         
function handleTouchMove(evt) {
    if ( ! xDown || ! yDown || ! started) {
        return;
    }

    var xUp = evt.touches[0].clientX;                                    
    var yUp = evt.touches[0].clientY;

    var xDiff = xDown - xUp;
    var yDiff = yDown - yUp;
    sensibility = Number(document.getElementById("sencontrol").value);

    if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
            /* right swipe */ 
        if ( xDiff > 0 ) {
          ytrigger = 0;
          dtrigger = 0;
          if(xtrigger<sensibility)
            xtrigger++
          else
            xtrigger=0;
          if(xtrigger==sensibility)
            move(-1, playfield, falling, true);
        } else {
            /* left swipe */
          xtrigger = 0;
          dtrigger = 0;
          if(ytrigger<sensibility)
            ytrigger++
          else
            ytrigger=0;
          if(ytrigger==sensibility)
            move(1, playfield, falling, true);
        }
        //console.log(xDiff);
    } else {
      if(yDiff<0){
        ytrigger = 0;
        xtrigger = 0;
        if(dtrigger<sensibility)
          dtrigger++
        else
          dtrigger=0;
        if(dtrigger==sensibility)
          fall(playfield, falling, true);
      }
    }
}
var KeyCodes = {
	SPACE : 32,
	ARROWL: 37,
	ARROWR: 39,
	ARROWU: 38,
	ARROWD: 40
};

document.onkeydown = function(event) {
	var keyCode;
	if (event == null) {
		keyCode = window.event.keyCode;
	} else {
		keyCode = event.keyCode;
	}
	switch (keyCode) {
		case KeyCodes.SPACE:
			start();
			break;
		case KeyCodes.ARROWD:
		  fall(playfield, falling, true);
		  break;
		case KeyCodes.ARROWL:
		  move(-1, playfield, falling, true);
		  break;
		case KeyCodes.ARROWR:
		  move(1, playfield, falling, true);
		  break;
		case KeyCodes.ARROWU:
		  rotate(playfield, falling, true);
		  break;
		default:
			break;
	}
}
		</script>
	</body>
</html>
