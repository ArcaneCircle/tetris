<!DOCTYPE html>
<html>
	<head>
	  <meta charset="utf-8"/>
	  <meta name="viewport" content="width=device-width"/>
		<link rel="stylesheet" type="text/css" href="css/index.css">
		<title>Tetris</title>
		<script src="webxdc.js"></script>
	</head>
	<body>
		<div class="app" id="touch">
			<center>
				<canvas id="background" width="1000" height="2000"></canvas>
				<canvas id="playfield" width="1000" height="2000"></canvas>
				<div id="scoreboard"></div>
				<!--
				<div class="UI" style="display:None">			
					<button onclick="move(-1, playfield, falling, true)">&larr;</button>
					<button onclick="rotate(playfield, falling, true)">&#8635;</button>
					<button onclick="move(1, playfield, falling, true)">&rarr;</button>
					<p></p>
					<br>
					<button onclick="fall(playfield, falling, true)">&darr;</button>
				</div>
				-->
			</center>
		</div>
		<div class="hidden">
			<img id="square" src="img/square.png" width="100" height="100">
		</div>
		<script type="text/javascript" src="js/Noise.js"></script>
		<script type="text/javascript" src="js/main.js"></script>
		<script type="text/javascript" src="webxdc-scores.js"></script>
		<script type="text/javascript">
		document.addEventListener("visibilitychange", function() {
      saveGame();
    });
    window.addEventListener("load", function() {
		   window.highscores.init("Tetris", "scoreboard").then(() => {
       restoreGame();
       scoreboard.classList.add("opened");
		   });
    });
    window.addEventListener("resize", function() {
      setup();
    });
    window.addEventListener("click", function() {
      start();
    });
    let portrait = window.matchMedia("(orientation: portrait)");
    portrait.addEventListener("change", function() { 
      setup();
    });
document.addEventListener('touchstart', handleTouchStart, false);        
document.addEventListener('touchmove', handleTouchMove, false);

var xDown = null;                                                        
var yDown = null;

var xtrigger = 0;
var ytrigger = 0;
var dtrigger = 0;

function getTouches(evt) {
  return evt.touches ||             // browser API
         evt.originalEvent.touches; // jQuery
}                                                     
                                                                         
function handleTouchStart(evt) {
    const firstTouch = getTouches(evt)[0];                                      
    xDown = firstTouch.clientX;                                      
    yDown = firstTouch.clientY;
    xtrigger = 0;
    ytrigger = 0;
    dtrigger = 0;
};                                                
                                                                         
function handleTouchMove(evt) {
    if ( ! xDown || ! yDown || ! started) {
        return;
    }

    var xUp = evt.touches[0].clientX;                                    
    var yUp = evt.touches[0].clientY;

    var xDiff = xDown - xUp;
    var yDiff = yDown - yUp;
    
    var sensibility = 4;
                                                                         
    if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
            /* right swipe */ 
        if ( xDiff > 0 ) {
          ytrigger = 0;
          dtrigger = 0;
          if(xtrigger<sensibility)
            xtrigger++
          else
            xtrigger=0;
          if(xtrigger==sensibility)
            move(-1, playfield, falling, true);
        } else {
            /* left swipe */
          xtrigger = 0;
          dtrigger = 0;
          if(ytrigger<sensibility)
            ytrigger++
          else
            ytrigger=0;
          if(ytrigger==sensibility)
            move(1, playfield, falling, true);
        }
        console.log(xDiff);
    } else {
      if(yDiff<0){
        ytrigger = 0;
        xtrigger = 0;
        if(dtrigger<sensibility)
          dtrigger++
        else
          dtrigger=0;
        if(dtrigger==sensibility)
          fall(playfield, falling, true);
      }
    }
}    
		</script>
	</body>
</html>
